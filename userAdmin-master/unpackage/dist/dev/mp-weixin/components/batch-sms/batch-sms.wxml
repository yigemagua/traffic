<view><uni-popup class="vue-ref" vue-id="21869218-1" type="center" is-mask-click="{{false}}" data-ref="smsPopup" data-event-opts="{{[['^change',[['popupChange']]]]}}" bind:change="__e" bind:__l="__l" vue-slots="{{['default']}}"><view class="sms-manager"><view class="sms-manager--header mb">群发短信</view><uni-forms class="vue-ref" vue-id="{{('21869218-2')+','+('21869218-1')}}" label-width="{{100}}" modelValue="{{smsDataModel}}" data-ref="smsForm" bind:__l="__l" vue-slots="{{['default']}}"><block wx:if="{{toType==='user'}}"><uni-forms-item vue-id="{{('21869218-3')+','+('21869218-2')}}" label="目标对象" bind:__l="__l" vue-slots="{{['default']}}"><block wx:if="{{isSelectedReceiver}}"><view>{{"当前已选择"+receiver.length+"人"}}</view></block><block wx:else><view>全部用户</view></block><view class="sms-data-tip">如需给指定用户发送，请在列表选择要发送的用户。</view></uni-forms-item></block><block wx:else><uni-forms-item vue-id="{{('21869218-4')+','+('21869218-2')}}" label="目标对象" bind:__l="__l" vue-slots="{{['default']}}"><view>{{"当前已选择"+receiver.length+"个标签"}}</view><view class="sms-data-tip">如标签关联的用户没有绑定手机号，将不会发送短信。</view></uni-forms-item></block><uni-forms-item vue-id="{{('21869218-5')+','+('21869218-2')}}" label="任务名称" name="name" required="{{true}}" rules="{{[{required:true,errorMessage:'请输入任务名称'}]}}" bind:__l="__l" vue-slots="{{['default']}}"><uni-easyinput bind:input="__e" vue-id="{{('21869218-6')+','+('21869218-5')}}" placeholder="请输入任务名称，例如 “放假通知”" value="{{smsDataModel.name}}" data-event-opts="{{[['^input',[['__set_model',['$0','name','$event',[]],['smsDataModel']]]]]}}" bind:__l="__l"></uni-easyinput></uni-forms-item><uni-forms-item vue-id="{{('21869218-7')+','+('21869218-2')}}" required="{{true}}" label="短信模板" name="templateId" rules="{{[{required:true,errorMessage:'请选择短信模板'}]}}" bind:__l="__l" vue-slots="{{['default']}}"><unicloud-db scoped-slots-compiler="augmented" class="vue-ref" vue-id="{{('21869218-8')+','+('21869218-7')}}" collection="batch-sms-template" field="_id as value,name as text,sign,content" data-ref="template_db" bind:__l="__l" vue-slots="{{['default']}}"><block wx:if="{{$root.m0}}"><block wx:if="{{!$root.m1}}"><block wx:if="{{$root.m2.length}}"><view><uni-data-select class="type m" vue-id="{{('21869218-9')+','+('21869218-8')}}" placeholder="请选择短信模板" size="mini" clear="{{false}}" localdata="{{$root.m3}}" value="{{smsDataModel.templateId}}" data-event-opts="{{[['^change',[['onSmsTemplateSelected']]],['^input',[['__set_model',['$0','templateId','$event',[]],['smsDataModel']]]]]}}" bind:change="__e" bind:input="__e" bind:__l="__l"></uni-data-select><view class="sms-data-tip">导入短信模版参考<navigator class="a-link _a" href="https://uniapp.dcloud.net.cn/uniCloud/admin.html#群发短信" target="_blank">教程</navigator>；若有新的短信模版，可<text data-event-opts="{{[['tap',[['chooseFile',['$event']]]]]}}" class="a-link" bindtap="__e">点此导入</text></view></view></block><block wx:else><view><button style="width:120px;" type="primary" size="mini" data-event-opts="{{[['tap',[['chooseFile',['$event']]]]]}}" bindtap="__e">上传短信模板</button><view class="sms-data-tip">当前未导入短信模板，请从dev.dcloud.net.cn的短信-<navigator href="https://dev.dcloud.net.cn/pages/sms/template" target="_blank" class="_a">模板配置</navigator>中导出短信模版，并在此导入。教程<navigator href="https://uniapp.dcloud.net.cn/uniCloud/admin.html#batch-sms" target="_blank" class="_a">详见</navigator></view></view></block></block><block wx:else>模板加载中...</block></block></unicloud-db></uni-forms-item><block wx:if="{{smsTemplateContent}}"><uni-forms-item vue-id="{{('21869218-10')+','+('21869218-2')}}" label="短信内容" bind:__l="__l" vue-slots="{{['default']}}"><view class="form-item-flex-center">{{smsTemplateContent}}</view></uni-forms-item></block><block wx:if="{{smsDataModel.templateData.length}}"><uni-forms-item vue-id="{{('21869218-11')+','+('21869218-2')}}" label="模板变量配置" error-message="{{smsTemplateDataErrorMessage}}" bind:__l="__l" vue-slots="{{['default']}}"><block wx:for="{{smsDataModel.templateData}}" wx:for-item="template" wx:for-index="index" wx:key="field"><view class="sms-data-item"><uni-easyinput bind:input="__e" class="field m" style="width:120px;flex:none;" vue-id="{{('21869218-12-'+index)+','+('21869218-11')}}" placeholder="字段" clearable="{{false}}" disabled="{{true}}" value="{{template.field}}" data-event-opts="{{[['^input',[['__set_model',['$0','field','$event',[]],[[['smsDataModel.templateData','field',template.field]]]]]]]}}" bind:__l="__l"></uni-easyinput><uni-easyinput bind:input="__e" class="value m" vue-id="{{('21869218-13-'+index)+','+('21869218-11')}}" placeholder="例 {uni-id-users.username}" clearable="{{false}}" value="{{template.value}}" data-event-opts="{{[['^input',[['__set_model',['$0','value','$event',[]],[[['smsDataModel.templateData','field',template.field]]]]]]]}}" bind:__l="__l"></uni-easyinput></view></block><view class="sms-data-tip">短信变量支持固定值和数据表查询两种方式；固定值如：各位同事，数据表查询如：{uni-id-users.username}；请注意，若使用数据表查询方式，目前仅支持查询 uni-id-users 表；并注意确保数据库中查询字段值不为空，否则短信将发送失败。</view></uni-forms-item></block></uni-forms><view class="uni-group"><button data-event-opts="{{[['tap',[['sendSms',[true]]]]]}}" class="uni-button" bindtap="__e">预览</button><button class="uni-button" type="primary" data-event-opts="{{[['tap',[['sendSms']]]]}}" bindtap="__e">提交</button></view></view><uni-icons class="close" vue-id="{{('21869218-14')+','+('21869218-1')}}" type="closeempty" size="24" data-event-opts="{{[['^click',[['close']]]]}}" bind:click="__e" bind:__l="__l"></uni-icons></uni-popup><uni-popup class="vue-ref" vue-id="21869218-15" type="center" is-mask-click="{{false}}" data-ref="previewPopup" bind:__l="__l" vue-slots="{{['default']}}"><view class="sms-manager preview"><view class="sms-manager--header mb"><view>短信预览</view><view class="sub-title">仅预览第一条短信内容</view></view><view class="content"><block wx:for="{{smsPreviewContent}}" wx:for-item="content" wx:for-index="__i0__"><view>{{content}}</view></block><view class="length">短信字数：<text class="num">{{smsPreviewContent.length?smsPreviewContent[0].length:0}}</text>字</view></view><view class="tip"><view>说明：</view><view>若从数据表中查询，字段内容长度会影响总字数，短信字数＝短信签名字数+短信内容字数。</view><view>短信长度不超过70个字，按照一条短信计费；超过70个字，按照67字/条拆分成多条计费。</view></view><view class="uni-group"><button data-event-opts="{{[['tap',[['e0',['$event']]]]]}}" class="uni-button" bindtap="__e">关闭</button></view></view></uni-popup></view>